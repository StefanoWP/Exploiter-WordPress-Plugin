<?php
/*
Plugin Name: Exploiter Code Scanner 
Description: Does what his name says,scan the eval( base64_decode() ) attack and more...
Version: alpha
Author: Stefano@pressidium.com
Author URI: http://pressidium.com
License: Do it your Own Buddy!
*/

define('SEND_EMAIL_ALERTS_TO','stefano@pressidium.com'); //obviously use your own email here 
############################################ START CLASS
class exploiter {
	public $infected_files = array();
	private $scanned_files = array();
	
	
	function __construct() {
		$this->scan(dirname(__FILE__));
		$this->sendalert();
	}
	
	
	function scan($dir) {
		$this->scanned_files[] = $dir;
		$files = scandir($dir);
		
		if(!is_array($files)) {
			throw new Exception('Hallo Buddie! We are unable to scan directory ' . $dir . '.  Are you sure that Permissions are on the Right Way??? Check them Please!');
		}
		
		foreach($files as $file) {
			if(is_file($dir.'/'.$file) && !in_array($dir.'/'.$file,$this->scanned_files)) {
				$this->check(file_get_contents($dir.'/'.$file),$dir.'/'.$file);
			} elseif(is_dir($dir.'/'.$file) && substr($file,0,1) != '.') {
				$this->scan($dir.'/'.$file);
			}
		}
	}
	
	
	function check($contents,$file) {
		$this->scanned_files[] = $file;
		if(preg_match('/eval\((base64|eval|\$_|\$\$|\$[A-Za-z_0-9\{]*(\(|\{|\[))/i',$contents)) {
			$this->infected_files[] = $file;
		}
	}
	function sendalert() {
		if(count($this->infected_files) != 0) {
			$message = "== MALICIOUS CODE FOUND == \n\n";
			$message .= "The files that we scan propably are infected: \n";
			foreach($this->infected_files as $inf) {
				$message .= "  -  $inf \n";
			}
			mail(SEND_EMAIL_ALERTS_TO,'Bad Ass Code Found here!',$message,'Came from:');
		}
	}
}
# INITIATE CLASS
ini_set('memory_limit', '-1');
new exploiter;
?>